using System;
using System.Windows;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;

namespace NotesApp
{
    public partial class MainWindow : Window
    {
        private readonly ObservableCollection<NoteModel> notes = new();
        private readonly TranslationService translator = new();

        public MainWindow()
        {
            InitializeComponent();
            NotesList.ItemsSource = notes;
            NewBtn.Click += (_, __) => CreateNewNote();
            SaveBtn.Click += (_, __) => SaveNote();
            TranslateBtn.Click += async (_, __) => await AutoTranslateAsync();
        }

        private void CreateNewNote()
        {
            TitleBox.Text = "";
            BodyBox.Text = "";
        }

        private void SaveNote()
        {
            // 本来は C++ NoteStorage と連携して保存する
            var n = new NoteModel
            {
                Title = TitleBox.Text,
                Body = BodyBox.Text,
                Date = DateTime.Now
            };
            notes.Add(n);
            MessageBox.Show("保存しました。", "NotesApp");
        }

        private async Task AutoTranslateAsync()
        {
            string target = ((System.Windows.Controls.ComboBoxItem)TargetLangBox.SelectedItem)?.Tag?.ToString() ?? "en";
            string src = DetectLanguage(BodyBox.Text); // 簡易判定
            string result = await translator.TranslateAsync(BodyBox.Text, src, target);
            if (!string.IsNullOrWhiteSpace(result))
            {
                var translatedNote = new NoteModel
                {
                    Title = TitleBox.Text + $"（翻訳:{target}）",
                    Body = result,
                    Date = DateTime.Now
                };
                notes.Add(translatedNote);
                MessageBox.Show("翻訳が完了しました！", "翻訳結果");
            }
        }

        // 超簡易な言語推定
        private string DetectLanguage(string text)
        {
            if (string.IsNullOrWhiteSpace(text)) return "auto";
            if (text.Any(c => c >= 0x3040 && c <= 0x30FF)) return "ja";
            if (text.Any(c => c >= 0xAC00 && c <= 0xD7A3)) return "ko";
            if (text.Any(c => c >= 0x4E00 && c <= 0x9FFF)) return "zh";
            return "en";
        }
    }
}
